

<!DOCTYPE html>
<html class="no-js" lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> Custom Payloads | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />
    <link
      rel="icon"
      href="../../_static/img/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="../../_static/img/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      href="../../_static/img/favicon-228x228.png"
      sizes="192x192"
    />
    <link
      rel="apple-touch-icon"
      href="../../_static/img/favicon-228x228.png"
    />
    <meta
      name="msapplication-TileImage"
      href="../../_static/img/favicon-228x228.png"
    />
    <link rel="canonical" href="https://docs.scylladb.com/" />
    <link rel="author" href="mailto:info@scylladb.com" />
  <!-- connect to domain of font files -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- optionally increase loading priority -->
  <link
    rel="preload"
    as="style"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- async CSS -->
  <link
    rel="stylesheet"
    media="print"
    onload="this.onload=null;this.removeAttribute('media');"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- no-JS fallback -->
  <noscript>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
    />
  </noscript>
  <link
    rel="stylesheet"
    href="../../_static/css/main.css"
    type="text/css"
  />
  <link
    rel="stylesheet"
    href="../../_static/pygments.css"
    type="text/css"
  /> <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />

  <script
    type="text/javascript"
    id="documentation_options"
    data-url_root="../../"
    src="../../_static/documentation_options.js"
  ></script>
  <script
    type="text/javascript"
    src="../../_static/js/runtime.bundle.js"
  ></script>
  <script
    type="text/javascript"
    src="../../_static/js/main.bundle.js"
  ></script> <script src="../../_static/underscore.js"></script> <script src="../../_static/doctools.js"></script> <script src="../../_static/language_data.js"></script> <script src="../../_static/clipboard.min.js"></script> <script src="../../_static/copybutton.js"></script>

    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-T8P2JP");
    </script>
    <!-- End Google Tag Manager -->
    <!-- Marketo -->
    <script type="text/javascript">
      (function () {
        var didInit = false;
        function initMunchkin() {
          if (didInit === false) {
            didInit = true;
            Munchkin.init("791-QBF-350");
          }
        }
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = "//munchkin.marketo.net/munchkin.js";
        s.onreadystatechange = function () {
          if (this.readyState == "complete" || this.readyState == "loaded") {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
    <!-- End Marketo -->
    <!-- Expertrec -->
    <script>
      var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
      var ci_search = document.createElement("script");
      ci_search.type = "text/javascript";
      ci_search.async = true;
      ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(ci_search, s);
    </script>
    <!-- End Expertrec -->

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/b1870adf6a.js"
      crossorigin="anonymous"
    ></script>
    <!-- End Font Awesome -->
  </head>
  
  <body>
     <header class="header">
  <div class="header-logo">
    <a class="header-logo__img" href="https://scylladb.com/">
      <img
        src="../../_static/img/logo-scylla-docs.svg"
        alt="Scylla Documentation Logo"
      />
    </a>
    <span class="header-logo__bar"></span>
    <a class="header-logo__text" href="https://docs.scylladb.com/">
      Documentation
    </a>
  </div>
  <div class="header-navigation">
    <ul
      class="dropdown menu scylla-dropdown scylla-dropdown--header"
      data-dropdown-menu
    >
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Server <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--about-us"></i>Scylla Open
              Source</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--enterprise"></i>Scylla
              Enterprise</a
            >
          </li>
          <li>
            <a
              href="https://scylla.docs.scylladb.com/master/alternator/alternator.html"
            >
              <i class="scylla-icon scylla-icon--overview"></i>Scylla
              Alternator</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Cloud <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://cloud.scylladb.com/">
              <i class="scylla-icon scylla-icon--cloud"></i>Scylla Cloud</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/scylla-cloud/">
              <i class="scylla-icon scylla-icon--cloud-docs"></i>Scylla Cloud
              Docs</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Tools <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://manager.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--manager"></i>Scylla Manager</a
            >
          </li>
          <li>
            <a href="https://monitoring.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--monitoring"></i>Scylla
              Monitoring Stack</a
            >
          </li>
          <li>
            <a href="https://operator.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--operator"></i>Scylla Operator
            </a>
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Drivers <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/"
            >
              <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
            </a>
          </li>
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/"
            >
              <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
            </a>
          </li>
        </ul>
      </li>
    </ul>
    <div class="header-button">
      <a href="https://www.scylladb.com/download/" class="button">Download</a>
    </div>
  </div>
  <div class="header-search-box">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav-toggle" data-toggle="side-nav">
  <div class="side-nav-toggle__button">
    <img src="../../_static/img/menu.svg" alt="Menu" />
  </div>
</div>
</header>
    <section class="layout ">
      <div class="content large-order-2">
         

        <div class="admonition caution">
          <p class="admonition-title">Caution</p>
          <p>
            You are not reading the latest stable version of this documentation.
            If you want up-to-date information, please have a look at
            <a href="../../../stable/index.html">
               3.10.2.x</a
            >.
          </p>
        </div>
        

        <div class="pre-content">
          <div class="pre-content__left"><div class="breadcrumbs">
  <span class="bread__item">
    <a
      href="https://java-driver.docs.scylladb.com"
      class="bread__highlight"
    >
      <i class="fas fa-home"></i> Scylla Java Driver</a
    ></span
  >
  
  <span class="bread__item"
    ><a href="../index.html">Manual</a></span
  >
  
  <span class="bread__item bread__item--last">Custom Payloads</span>
</div></div>
          <div class="pre-content__right"><ul
  class="dropdown menu scylla-dropdown scylla-dropdown--contribute"
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
      <div class="scylla-dropdown__title--body">
        <i class="icon fa fa-github" aria-hidden="true"></i>
        Contribute
      </div>
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content">
      <li>
        <a
          href="https://github.com/scylladb/java-driver/issues/new?title=Issue in page Custom Payloads&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://java-driver.docs.scylladb.com/scylla-3.x/manual/custom_payloads/index%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix"
          target="_blank"
          >Report a doc issue
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
             
        <a
          href="https://github.com/scylladb/java-driver/edit/scylla-3.x/docs/source/manual/custom_payloads/index.md"
          target="_blank"
          >Edit this page
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
        <a href="https://docs.scylladb.com/contribute/" target="_blank"
          >Learn how to contribute
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
    </ul>
  </li>
</ul></div>
        </div>
         <div class="section" id="custom-payloads">
<h1>Custom Payloads<a class="headerlink" href="#custom-payloads" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="../native_protocol/">native protocol</a> version 4 introduces a new feature called <a class="reference external" href="https://issues.apache.org/jira/browse/CASSANDRA-8553">Custom Payloads</a>.</p>
<p>According to the <a class="reference external" href="https://github.com/apache/cassandra/blob/trunk/doc/native_protocol_v4.spec">protocol V4 specification</a>, custom payloads are generic key-value maps
where keys are strings and each value is an arbitrary sequence of bytes. Currently payloads
can be sent by clients along with all <code class="docutils literal notranslate"><span class="pre">QUERY</span></code>, <code class="docutils literal notranslate"><span class="pre">PREPARE</span></code>, <code class="docutils literal notranslate"><span class="pre">EXECUTE</span></code> and <code class="docutils literal notranslate"><span class="pre">BATCH</span></code> requests.</p>
<p>Custom payloads can be used to convey user-specific information from clients to servers and vice versa.
<em>Please note that this is an advanced feature that requires specific server-side configuration (see below).</em></p>
<div class="section" id="enabling-custom-payloads-on-c-nodes">
<h2>Enabling custom payloads on C* nodes<a class="headerlink" href="#enabling-custom-payloads-on-c-nodes" title="Permalink to this headline">¶</a></h2>
<p>What the server is supposed to do with a payload depends on the <a class="reference external" href="https://issues.apache.org/jira/browse/CASSANDRA-6659">QueryHandler</a> used server-side
to decode requests. Unsurprisingly, the default <code class="docutils literal notranslate"><span class="pre">QueryHandler</span></code> implementation used by Cassandra
simply ignores all payloads. However, users can replace it with their own implementation,
thus being able to to process user-specific payloads; the payload format as well as
the serialization and deserialization logic is entirely left for clients to implement.
Needless to say, the same encoding and decoding logic should be applied on both client
and server endpoints.</p>
<p>This section is a small how-to to help driver users getting started with
custom payload processing server-side. For more detailed information,
please refer to the Cassandra documentation itself.</p>
<p>To enable a custom <code class="docutils literal notranslate"><span class="pre">QueryHandler</span></code> for a Cassandra node, its JVM should be
started with the system property <code class="docutils literal notranslate"><span class="pre">cassandra.custom_query_handler_class</span></code> set
to a fully qualified name of a class implementing <code class="docutils literal notranslate"><span class="pre">org.apache.cassandra.cql3.QueryHandler</span></code>.
This class should be of course available on the node’s classpath.</p>
<p>This can be achieved with the following steps:</p>
<ol class="simple">
<li><p>Add your implementation jar to the <code class="docutils literal notranslate"><span class="pre">CLASSPATH</span></code> environment variable;</p></li>
<li><p>Add the following to <code class="docutils literal notranslate"><span class="pre">$CASSANDRA_CONF/cassandra-env.sh</span></code>:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JVM_EXTRA_OPTS</span><span class="o">=</span><span class="s2">&quot;-Dcassandra.custom_query_handler_class=fully.qualified.name.of.MyQueryHandler&quot;</span>
</pre></div>
</div>
<p>Of course, all nodes in the cluster <em>must</em> be started with the same QueryHandler, otherwise
payloads sent by the driver could get lost.</p>
</div>
<div class="section" id="implementation-notes">
<h2>Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline">¶</a></h2>
<p>Payloads in the Java driver are represented as <code class="docutils literal notranslate"><span class="pre">Map&lt;String,ByteBuffer&gt;</span></code> instances.
It is safe to use any <code class="docutils literal notranslate"><span class="pre">Map</span></code> implementation, including unsynchronized implementations
such as <code class="docutils literal notranslate"><span class="pre">java.util.HashMap</span></code>; the driver will create defensive, thread-safe copies of
user-supplied maps. However, <code class="docutils literal notranslate"><span class="pre">ByteBuffer</span></code> instances are inherently mutable,
so callers should take care not to modify the <code class="docutils literal notranslate"><span class="pre">ByteBuffer</span></code> values in a payload map <em>after</em> submitting it
to the driver as it could lead to unexpected results.</p>
<div class="section" id="null-values">
<h3>Null values<a class="headerlink" href="#null-values" title="Permalink to this headline">¶</a></h3>
<p>Note that, for thread safety reasons, the Java driver does not permit <code class="docutils literal notranslate"><span class="pre">null</span></code> keys nor <code class="docutils literal notranslate"><span class="pre">null</span></code> values in a payload map;
including a <code class="docutils literal notranslate"><span class="pre">null</span></code> in your payload will result in a <code class="docutils literal notranslate"><span class="pre">NullPointerException</span></code> being immediately thrown.</p>
<p>However, the protocol specification <em>does</em> allow <code class="docutils literal notranslate"><span class="pre">null</span></code> values. If you need to include
a <code class="docutils literal notranslate"><span class="pre">null</span></code> value in your payload map, this can be achieved with the Java driver
by using the special value <code class="docutils literal notranslate"><span class="pre">Statement.NULL_PAYLOAD_VALUE</span></code>.</p>
<div class="section" id="payload-length-limitations">
<h4>Payload length limitations<a class="headerlink" href="#payload-length-limitations" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>Payload maps cannot have more than 65,535 entries.</p></li>
<li><p>Payload map values are limited to a maximum length of <code class="docutils literal notranslate"><span class="pre">Integer.MAX_VALUE</span></code> (2<sup><small>31</small></sup> − 1) bytes each.</p></li>
</ol>
</div>
</div>
</div>
<div class="section" id="sending-custom-payloads">
<h2>Sending custom payloads<a class="headerlink" href="#sending-custom-payloads" title="Permalink to this headline">¶</a></h2>
<p>A custom payload can be attached to any <code class="docutils literal notranslate"><span class="pre">Statement</span></code> via <code class="docutils literal notranslate"><span class="pre">Statement.setOutgoingPayload()</span></code>.</p>
<p>Once the payload is set, you can either prepare the statement or execute it;
in both cases, the payload will be sent along with the <code class="docutils literal notranslate"><span class="pre">PREPARE</span></code> or <code class="docutils literal notranslate"><span class="pre">QUERY</span></code> request respectively:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;SELECT foo FROM bar WHERE qix = 1&quot;</span><span class="o">);</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span> <span class="c1">// myCustomPayload will be sent with QUERY request</span>
<span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span> <span class="c1">// myCustomPayload will be sent with PREPARE request</span>
</pre></div>
</div>
<p>Naturally, you can also set a payload when using the <code class="docutils literal notranslate"><span class="pre">QueryBuilder</span></code> API:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&quot;c2&quot;</span><span class="o">).</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;t1&quot;</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">&quot;c1&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">)).</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span> <span class="c1">// myCustomPayload will be sent with EXECUTE request</span>
</pre></div>
</div>
<p>When sending payloads with batches, please note that payloads must be attached to the
<code class="docutils literal notranslate"><span class="pre">BatchStatement</span></code> itself, <em>not</em> to internal statements:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;INSERT INTO t1 (c1, c2) values (&#39;foo&#39;, &#39;bar&#39;)&quot;</span><span class="o">)</span>
<span class="c1">// correct</span>
<span class="n">Statement</span> <span class="n">batch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatchStatement</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
<span class="n">batch</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">batch</span><span class="o">);</span>  <span class="c1">// myCustomPayload will be sent with BATCH request</span>
<span class="c1">// wrong</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span>
<span class="n">Statement</span> <span class="n">batch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatchStatement</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">batch</span><span class="o">);</span> <span class="c1">// myCustomPayload will NOT be sent with BATCH request</span>
</pre></div>
</div>
<p>One important note about paging requests: if your query needs to paginate,
any outgoing payload set on the executed statement <em>will be transparently
sent over and over for every new page request</em>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span>
<span class="n">ResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(...);</span> <span class="c1">// myCustomPayload will be sent with first QUERY request</span>
<span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">row</span> <span class="o">:</span> <span class="n">rows</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// if additional QUERY requests are sent, all of them will send the same payload</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And finally, note that custom payloads can only be used with protocol versions &gt;= 4;
trying to set a payload under lower protocol versions will result in
an <a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/exceptions/UnsupportedFeatureException.html">UnsupportedFeatureException</a> (wrapped in a <a class="reference external" href="https://java-driver.docs.scylladb.com/stable/api/com/datastax/driver/core/exceptions/NoHostAvailableException.html">NoHostAvailableException</a>)
when the request is encoded.</p>
<p>If you want to defensively protect your code against these errors, you can either:</p>
<ol class="simple">
<li><p>Force the protocol version when creating your <code class="docutils literal notranslate"><span class="pre">Cluster</span></code> instance:</p></li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withProtocolVersion</span><span class="o">(</span><span class="n">ProtocolVersion</span><span class="o">.</span><span class="na">V4</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Inspect the current negotiated protocol version, and only send payloads if version is equal to or
greater than 4:</p></li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ProtocolVersion</span> <span class="n">myCurrentVersion</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">()</span>
    <span class="o">.</span><span class="na">getProtocolOptions</span><span class="o">()</span>
    <span class="o">.</span><span class="na">getProtocolVersion</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">myCurrentVersion</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">ProtocolVersion</span><span class="o">.</span><span class="na">V4</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// only send custom payloads if current protocol version supports it</span>
    <span class="n">statement</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="receiving-custom-payloads">
<h2>Receiving custom payloads<a class="headerlink" href="#receiving-custom-payloads" title="Permalink to this headline">¶</a></h2>
<p>Custom payloads sent back by the server can be retrieved in the following ways:</p>
<ol class="simple">
<li><p>From a <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code>: use the <code class="docutils literal notranslate"><span class="pre">ExecutionInfo</span></code> class to retrieve the payload sent by the server.</p></li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
<span class="n">ResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(...);</span>
<span class="c1">// last payload sent by the server</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">serverPayload</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="na">getExecutionInfo</span><span class="o">().</span><span class="na">getIncomingPayload</span><span class="o">();</span>
</pre></div>
</div>
<p>If your query required pagination (multiple <code class="docutils literal notranslate"><span class="pre">QUERY</span></code> requests),
the above method would only return the last payload sent by server
with its last <code class="docutils literal notranslate"><span class="pre">RESULT</span></code> response. If you need to retrieve all the
payloads for all <code class="docutils literal notranslate"><span class="pre">RESULT</span></code> responses, use the following method instead:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
<span class="n">ResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(...);</span>
<span class="c1">//all payloads sent by the server</span>
<span class="k">for</span> <span class="o">(</span><span class="n">ExecutionInfo</span> <span class="n">info</span> <span class="o">:</span> <span class="n">rows</span><span class="o">.</span><span class="na">getAllExecutionInfo</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">serverPayload</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getIncomingPayload</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<ol class="simple">
<li><p>From a <code class="docutils literal notranslate"><span class="pre">PreparedStatement</span></code>: to retrieve the payload that the server sent back
with its <code class="docutils literal notranslate"><span class="pre">PREPARED</span></code> response, use the following method:</p></li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(...);</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">serverPayload</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">getIncomingPayload</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-payloads-and-prepared-statements">
<h2>Custom Payloads and Prepared Statements<a class="headerlink" href="#custom-payloads-and-prepared-statements" title="Permalink to this headline">¶</a></h2>
<p>If you use either <code class="docutils literal notranslate"><span class="pre">Session.prepare(RegularStatement)</span></code> or <code class="docutils literal notranslate"><span class="pre">Session.prepareAsync(RegularStatement)</span></code>
to prepare a statement, as with all other properties in the given statement, its outgoing
payload, if any, will become the default outgoing payload for the prepared statement.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">)</span>
<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(...);</span> <span class="c1">// myCustomPayload will be sent with PREPARE request </span>
                                             <span class="c1">// AND become the default outgoing payload</span>
</pre></div>
</div>
<p>Naturally, you can also set a default outgoing payload on the <code class="docutils literal notranslate"><span class="pre">PreparedStatement</span></code> instance itself.
The code below is roughly equivalent to the one above - except that the payload is not sent
with the <code class="docutils literal notranslate"><span class="pre">PREPARE</span></code> request:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(...);</span> <span class="c1">// no payload sent with PREPARE request</span>
<span class="n">ps</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">)</span> <span class="c1">// default outgoing payload is now myCustomPayload</span>
</pre></div>
</div>
<p>But <code class="docutils literal notranslate"><span class="pre">PreparedStatement</span></code> has also a <code class="docutils literal notranslate"><span class="pre">getIncomingPayload()</span></code> method, which, as we already know,
can be used to retrieve incoming payloads sent back by the server that prepared the request.</p>
<p>When binding a statement - with either <code class="docutils literal notranslate"><span class="pre">PreparedStatement.bind()</span></code> or <code class="docutils literal notranslate"><span class="pre">PreparedStatement.bind(Object...)</span></code>) -
<code class="docutils literal notranslate"><span class="pre">BoundStatement</span></code> instances will also inherit payloads.</p>
<p>To determine which payload is going to be used as outgoing payload for a bound statement,
the following rules apply:</p>
<ol class="simple">
<li><p>If the prepared statement has a non-null outgoing payload, all instances of <code class="docutils literal notranslate"><span class="pre">BoundStatement</span></code>
created out of it will inherit that payload as their outgoing payload;</p></li>
<li><p>Otherwise, if the prepared statement has a non-null incoming payload, all instances of <code class="docutils literal notranslate"><span class="pre">BoundStatement</span></code>
created out of it will inherit that payload as their outgoing payload;</p></li>
<li><p>Otherwise, all instances of <code class="docutils literal notranslate"><span class="pre">BoundStatement</span></code> created out of it
won’t have any outgoing payload set by default; users can however set an outgoing payload on
individual <code class="docutils literal notranslate"><span class="pre">BoundStatement</span></code> instances by calling their <code class="docutils literal notranslate"><span class="pre">setOutgoingPayload()</span></code> method,
like in the example below:</p></li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
<span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(...);</span> <span class="c1">// no payload sent with PREPARE request</span>
<span class="n">BoundStatement</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// no outgoing payload by default</span>
<span class="n">bs</span><span class="o">.</span><span class="na">setOutgoingPayload</span><span class="o">(</span><span class="n">myCustomPayload</span><span class="o">);</span> <span class="c1">// outgoing payload for this specific statement</span>
<span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span> <span class="c1">// myCustomPayload will be sent with EXECUTE request for this bound statement only</span>
</pre></div>
</div>
</div>
<div class="section" id="debugging-custom-payloads">
<h2>Debugging custom payloads<a class="headerlink" href="#debugging-custom-payloads" title="Permalink to this headline">¶</a></h2>
<p>When debugging custom payloads, set the <code class="docutils literal notranslate"><span class="pre">com.datastax.driver.core.Message</span></code> logger to the <code class="docutils literal notranslate"><span class="pre">TRACE</span></code> level, e.g. with Log4J:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;com.datastax.driver.core.Message&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;TRACE&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>
</pre></div>
</div>
<p>This will log a message for every request and every response that contains a non-null payload.
The log message contains a pretty-printed version of the payload itself, and its total length in bytes.</p>
</div>
</div>
  <div class="content-navigation">
  <div class="navigation navigation--prev">
    <a class="navigation__link" href="../custom_codecs/index.html">
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
      </button>
      <div class="navigation__title">
        <span class="colored">PREVIOUS</span> <br />Custom Codecs
      </div>
    </a>
  </div>
  <div class="navigation navigation--next">
    <a class="navigation__link" href="../idempotence/index.html">
      <div class="navigation__title">
        <span class="colored">NEXT</span> <br />Query idempotence
      </div>
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-right"></i>
      </button>
    </a>
  </div>
</div> 
      </div>
      <div
        class="sidebar-left  large-order-1"
      > <div id="side-nav" class="side-nav custom-scroll-bar" data-closable data-toggler=".show">
  <button class="collapsible-button">
    <i class="scylla-icon scylla-icon--chevron-left"></i>
  </button>
  <div class="side-nav-content">
    <div class="side-nav__search">
      <div class="search-box">
        <ci-search></ci-search>
      </div>
    </div>
    <div class="side-nav__versions">
       <ul
  class="dropdown menu scylla-dropdown scylla-dropdown--versions "
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
       3.x 
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content"> 
      <li>
        <a href="../../../scylla-3.7.2.x/index.html"
          >3.7.2.x</a
        >
      </li>
       
      <li>
        <a href="../../../stable/index.html"
          >3.10.2.x</a
        >
      </li>
       
    </ul>
  </li>
</ul> 
    </div>
    <div class="side-nav__content">
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Scylla Java Driver for Scylla and Apache Cassandra®</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Manual</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../address_resolution/index.html">Address resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async/index.html">Asynchronous programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auth/index.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/index.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control_connection/index.html">Control connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_codecs/index.html">Custom Codecs</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Custom Payloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../idempotence/index.html">Query idempotence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../load_balancing/index.html">Load balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/index.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics/index.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../native_protocol/index.html">Native protocol</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../object_mapper/index.html">Object Mapper</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../object_mapper/creating/index.html">Definition of mapped classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../object_mapper/custom_codecs/index.html">Using custom codecs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../object_mapper/using/index.html">Using the mapper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../osgi/index.html">OSGi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paging/index.html">Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pooling/index.html">Connection pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../query_timestamps/index.html">Query timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reconnection/index.html">Reconnection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../retries/index.html">Retries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shaded_jar/index.html">Using the shaded JAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../socket_options/index.html">Socket options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../speculative_execution/index.html">Speculative query execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ssl/index.html">SSL</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../statements/index.html">Statements</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../statements/simple/index.html">Simple statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statements/prepared/index.html">Prepared statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statements/built/index.html">Built statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../statements/batch/index.html">Batch statements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tuples/index.html">Using Tuples with the Java driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../udts/index.html">User-defined types</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../upgrade_guide/index.html">Upgrade guide</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/index.html">Migrating from Astyanax</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label for="toctree-checkbox-5"><i class="scylla-icon scylla-icon--expand"></i></label><div class="break"></div><ul>
<li class="toctree-l3"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/configuration/index.html">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/language_level_changes/index.html">Language change : from Thrift to CQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../upgrade_guide/migrating_from_astyanax/queries_and_results/index.html">Queries and Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/index.html">Changelog</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
      
      <div class="sidebar-right large-order-3">
         <div class="secondary-side-nav custom-scroll-bar">
  <div class="secondary-side-nav__content">
    <p class="topic-title">On this page</p>
    <ul>
<li><a class="reference internal" href="#">Custom Payloads</a><ul>
<li><a class="reference internal" href="#enabling-custom-payloads-on-c-nodes">Enabling custom payloads on C* nodes</a></li>
<li><a class="reference internal" href="#implementation-notes">Implementation Notes</a><ul>
<li><a class="reference internal" href="#null-values">Null values</a><ul>
<li><a class="reference internal" href="#payload-length-limitations">Payload length limitations</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sending-custom-payloads">Sending custom payloads</a></li>
<li><a class="reference internal" href="#receiving-custom-payloads">Receiving custom payloads</a></li>
<li><a class="reference internal" href="#custom-payloads-and-prepared-statements">Custom Payloads and Prepared Statements</a></li>
<li><a class="reference internal" href="#debugging-custom-payloads">Debugging custom payloads</a></li>
</ul>
</li>
</ul>

  </div>
</div> 
      </div>
    </section>

    <footer class="footer">
  <div class="footer-group">
    <div class="footer-top">
      <a class="footer-logo" href="https://www.scylladb.com"
        ><img
          src="../../_static/img/logo-scylla-horizontal-RGB.svg"
          alt="Logo"
      /></a>
      <div class="footer-links">
        <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
        <a
          class="footer-links__link"
          href="https://www.scylladb.com/company/contact-us/"
          >Contact Us</a
        >
        <a class="footer-links__link" href="https://www.scylladb.com/company/"
          >About Us</a
        >
      </div>
      <div class="footer-actions">
        <a
          class="footer-actions__link"
          href="https://groups.google.com/g/scylladb-users"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User mailing list"
            data-position="bottom"
          >
            <img
              src="../../_static/img/icons/icon-mail-list.svg"
              alt="Mail List Icon"
            />
          </span>
        </a>
        <a
          class="footer-actions__link"
          href="http://slack.scylladb.com/"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User Slack channel"
            data-position="bottom"
          >
            <img
              src="../../_static/img/icons/icon-slack.svg"
              alt="Slack Icon"
          /></span>
        </a>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="footer-bottom__copyright"> &#169; 2022, ScyllaDB. All rights reserved.
      </div>
      <div class="footer-bottom__last-updated">
        Last updated on 07 February 2022.
      </div>
      <div class="footer-bottom__version">
        Powered by
        <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a> &amp;
        <a href="https://sphinx-theme.scylladb.com/"
          >ScyllaDB Theme 1.0.6</a
        >
      </div>
    </div>
  </div>
</footer>

    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
  </body>
</html>